name: CI

on:
  pull_request:
    branches:
      - "**"
  push:
    branches:
      - master
  workflow_call:

jobs:
  checks:
    name: Run Checks
    runs-on: ubuntu-latest
    strategy:
      matrix:
        emacs_version:
          - "29.1"
          - "29.4"
          - "snapshot"
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Emacs
        uses: jcs090218/setup-emacs@master
        with:
          version: ${{ matrix.emacs_version }}

      - name: Compile
        run: |
          ./scripts/compile.sh

      - name: Lint
        run: |
          ./scripts/lint.sh

      - name: Check documentation
        run: |
          emacs -Q --batch \
            --eval "(checkdoc-file \"netlinx-mode.el\")" \
            --eval "(checkdoc-file \"netlinx-mode-font-lock.el\")"

      - name: Load package
        run: |
          emacs -Q --batch \
            --eval "(add-to-list 'load-path \".\")" \
            --eval "(require 'netlinx-mode)" \
            --eval "(message \"Package loaded successfully\")"

      - name: Check tree-sitter grammar availability
        run: |
          emacs -Q --batch \
            --eval "(require 'treesit)" \
            --eval "(message \"NetLinx grammar available: %s\" (treesit-language-available-p 'netlinx))"
